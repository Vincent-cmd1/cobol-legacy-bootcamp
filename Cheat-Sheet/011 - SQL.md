# Guide SQL Complet - Cheat Sheet

## üîç Requ√™tes de base (SELECT)

### S√©lection simple
```sql
-- Colonnes sp√©cifiques
SELECT nom, prenom, age FROM utilisateurs;

-- Toutes les colonnes
SELECT * FROM produits;

-- Avec alias
SELECT nom AS nom_complet, prix * 1.2 AS prix_ttc
FROM produits AS p;
```

## üìã Filtres et conditions (WHERE)

### Op√©rateurs de comparaison
```sql
-- √âgalit√© et in√©galit√©
SELECT * FROM employes WHERE salaire = 3000;
SELECT * FROM employes WHERE statut != 'inactif';

-- Comparaisons num√©riques
SELECT * FROM produits WHERE prix > 100 AND prix <= 500;
SELECT * FROM commandes WHERE total BETWEEN 50 AND 200;

-- Listes de valeurs
SELECT * FROM clients WHERE ville IN ('Paris', 'Lyon', 'Marseille');
SELECT * FROM produits WHERE categorie NOT IN ('obsolete', 'test');
```

### Recherche textuelle
```sql
-- Recherche exacte
SELECT * FROM utilisateurs WHERE nom = 'Dupont';

-- Recherche avec motifs
SELECT * FROM produits WHERE nom LIKE 'iPhone%';        -- Commence par iPhone
SELECT * FROM clients WHERE email LIKE '%@gmail.com';   -- Finit par @gmail.com
SELECT * FROM articles WHERE titre LIKE '%SQL%';        -- Contient SQL
SELECT * FROM codes WHERE reference LIKE 'A_B';         -- A + 1 caract√®re + B
```

### Gestion des valeurs NULL
```sql
-- Rechercher les valeurs manquantes
SELECT * FROM clients WHERE telephone IS NULL;
SELECT * FROM employes WHERE date_fin IS NOT NULL;

-- Remplacer les NULL par une valeur par d√©faut
SELECT nom, COALESCE(telephone, 'Non renseign√©') AS contact
FROM clients;
```
### Op√©rateurs num√©riques
| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `=`, `!=`, `<>` | √âgalit√©/In√©galit√© | `age = 25` |
| `<`, `<=`, `>`, `>=` | Comparaisons | `price > 100` |
| `BETWEEN ... AND ...` | Dans une plage | `age BETWEEN 18 AND 65` |
| `NOT BETWEEN ... AND ...` | Hors d'une plage | `price NOT BETWEEN 10 AND 50` |
| `IN (...)` | Dans une liste | `id IN (1, 2, 3)` |
| `NOT IN (...)` | Pas dans une liste | `status NOT IN ('pending', 'cancelled')` |

### Op√©rateurs de texte
| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `=` | Comparaison exacte (sensible √† la casse) | `name = 'John'` |
| `!=`, `<>` | In√©galit√© exacte | `name != 'John'` |
| `LIKE` | Comparaison avec motifs | `name LIKE 'J%'` |
| `NOT LIKE` | Exclusion avec motifs | `name NOT LIKE '%admin%'` |
| `%` | Z√©ro ou plusieurs caract√®res | `'%cat%'` (trouve "cat", "cats", "scatter") |
| `_` | Un seul caract√®re | `'c_t'` (trouve "cat", "cut" mais pas "cart") |

## üîÑ Tri et pagination

### Tri des r√©sultats
```sql
-- Tri simple
SELECT * FROM produits ORDER BY prix DESC;

-- Tri multiple
SELECT * FROM employes 
ORDER BY departement ASC, salaire DESC;

-- Tri avec expressions
SELECT nom, prix, prix * quantite AS total
FROM produits 
ORDER BY total DESC;
```

### Pagination
```sql
-- Premi√®re page (20 premiers r√©sultats)
SELECT * FROM articles ORDER BY date_creation DESC LIMIT 20;

-- Deuxi√®me page (r√©sultats 21 √† 40)
SELECT * FROM articles ORDER BY date_creation DESC LIMIT 20 OFFSET 20;

-- Top 10 des ventes
SELECT produit, SUM(quantite) AS total_vendu
FROM ventes 
GROUP BY produit 
ORDER BY total_vendu DESC 
LIMIT 10;
```

## üîó Jointures (JOINS)

### Types de jointures avec exemples
```sql
-- INNER JOIN : Seulement les correspondances
SELECT c.nom, c.email, co.numero, co.total
FROM clients c
INNER JOIN commandes co ON c.id = co.client_id;

-- LEFT JOIN : Tous les clients, m√™me sans commandes
SELECT c.nom, COUNT(co.id) AS nb_commandes
FROM clients c
LEFT JOIN commandes co ON c.id = co.client_id
GROUP BY c.id, c.nom;

-- RIGHT JOIN : Toutes les commandes, m√™me sans client valide
SELECT c.nom, co.numero
FROM clients c
RIGHT JOIN commandes co ON c.id = co.client_id;

-- FULL JOIN : Tous les enregistrements des deux tables
SELECT c.nom, co.numero
FROM clients c
FULL JOIN commandes co ON c.id = co.client_id;
```

### Jointures multiples
```sql
-- Exemple avec 3 tables
SELECT 
    c.nom AS client,
    p.nom AS produit,
    lc.quantite,
    lc.prix_unitaire
FROM clients c
INNER JOIN commandes co ON c.id = co.client_id
INNER JOIN lignes_commande lc ON co.id = lc.commande_id
INNER JOIN produits p ON lc.produit_id = p.id
WHERE co.date_commande >= '2024-01-01';
```

## üßÆ Fonctions d'agr√©gation

### Fonctions de base
```sql
-- Comptage
SELECT COUNT(*) AS total_clients FROM clients;
SELECT COUNT(telephone) AS clients_avec_tel FROM clients;

-- Calculs statistiques
SELECT 
    MIN(prix) AS prix_min,
    MAX(prix) AS prix_max,
    AVG(prix) AS prix_moyen,
    SUM(quantite) AS stock_total
FROM produits;
```

### GROUP BY et HAVING
```sql
-- Ventes par cat√©gorie
SELECT 
    categorie,
    COUNT(*) AS nb_produits,
    AVG(prix) AS prix_moyen
FROM produits
GROUP BY categorie
ORDER BY prix_moyen DESC;

-- Filtrage des groupes avec HAVING
SELECT 
    ville,
    COUNT(*) AS nb_clients
FROM clients
GROUP BY ville
HAVING COUNT(*) > 5
ORDER BY nb_clients DESC;

-- Exemple complexe : commandes importantes par mois
SELECT 
    DATE_FORMAT(date_commande, '%Y-%m') AS mois,
    COUNT(*) AS nb_commandes,
    SUM(total) AS chiffre_affaires
FROM commandes
WHERE total > 100
GROUP BY DATE_FORMAT(date_commande, '%Y-%m')
HAVING SUM(total) > 10000
ORDER BY mois DESC;
```

## üéØ Fonctions utiles

### Fonctions de cha√Æne
```sql
-- Manipulation de texte
SELECT 
    UPPER(nom) AS nom_majuscule,
    LOWER(email) AS email_minuscule,
    LENGTH(description) AS longueur_desc,
    CONCAT(prenom, ' ', nom) AS nom_complet,
    SUBSTRING(telephone, 1, 2) AS indicatif
FROM clients;

-- Recherche et remplacement
SELECT 
    REPLACE(adresse, 'rue', 'Rue') AS adresse_formatee,
    TRIM(nom) AS nom_sans_espaces
FROM clients;
```

### Fonctions de date
```sql
-- Dates courantes
SELECT 
    NOW() AS maintenant,
    CURRENT_DATE() AS aujourd_hui,
    CURRENT_TIME() AS heure_actuelle;

-- Calculs de dates
SELECT 
    nom,
    date_naissance,
    YEAR(NOW()) - YEAR(date_naissance) AS age,
    DATEDIFF(NOW(), date_inscription) AS jours_membre
FROM utilisateurs;

-- Formatage de dates
SELECT 
    DATE_FORMAT(date_commande, '%d/%m/%Y') AS date_fr,
    DATE_FORMAT(date_commande, '%W %M %Y') AS date_longue
FROM commandes;
```

### Fonctions math√©matiques
```sql
-- Calculs et arrondis
SELECT 
    produit,
    prix_ht,
    prix_ht * 1.20 AS prix_ttc,
    ROUND(prix_ht * 1.20, 2) AS prix_ttc_arrondi,
    CEIL(prix_ht) AS prix_superieur,
    FLOOR(prix_ht) AS prix_inferieur,
    ABS(prix_ht - prix_concurrent) AS ecart_prix
FROM produits;
```

## üìä Requ√™tes avanc√©es

### Sous-requ√™tes
```sql
-- Produits plus chers que la moyenne
SELECT nom, prix 
FROM produits 
WHERE prix > (SELECT AVG(prix) FROM produits);

-- Clients ayant command√© plus de 5 fois
SELECT nom, email
FROM clients 
WHERE id IN (
    SELECT client_id 
    FROM commandes 
    GROUP BY client_id 
    HAVING COUNT(*) > 5
);
```

### Expressions conditionnelles
```sql
-- CASE WHEN
SELECT 
    nom,
    prix,
    CASE 
        WHEN prix < 50 THEN '√âconomique'
        WHEN prix BETWEEN 50 AND 200 THEN 'Moyen'
        ELSE 'Premium'
    END AS gamme
FROM produits;

-- IF (MySQL) ou CASE pour conditions simples
SELECT 
    nom,
    stock,
    IF(stock > 0, 'En stock', 'Rupture') AS disponibilite
FROM produits;
```

## üîÑ Structure compl√®te d'une requ√™te

```sql
SELECT DISTINCT 
    c.nom,
    c.ville,
    COUNT(co.id) AS nb_commandes,
    SUM(co.total) AS ca_total,
    AVG(co.total) AS panier_moyen
FROM clients c
LEFT JOIN commandes co ON c.id = co.client_id
    AND co.date_commande >= '2024-01-01'
WHERE c.statut = 'actif'
  AND c.ville IN ('Paris', 'Lyon', 'Marseille')
GROUP BY c.id, c.nom, c.ville
HAVING COUNT(co.id) > 0
ORDER BY ca_total DESC, c.nom ASC
LIMIT 50;
```

## üìà Ordre d'ex√©cution SQL

1. **FROM** et **JOIN** - Constitution du jeu de donn√©es
2. **WHERE** - Filtrage des lignes individuelles
3. **GROUP BY** - Regroupement des donn√©es
4. **HAVING** - Filtrage des groupes
5. **SELECT** - S√©lection et calcul des colonnes
6. **DISTINCT** - Suppression des doublons
7. **ORDER BY** - Tri des r√©sultats
8. **LIMIT/OFFSET** - Limitation des r√©sultats

## üí° Bonnes pratiques

### Optimisation des performances
```sql
-- ‚úÖ Bon : Filtrer avant de joindre
SELECT c.nom, co.total
FROM clients c
INNER JOIN (
    SELECT client_id, total 
    FROM commandes 
    WHERE date_commande >= '2024-01-01'
) co ON c.id = co.client_id;

-- ‚ùå √âviter : Jointure puis filtrage
SELECT c.nom, co.total
FROM clients c
INNER JOIN commandes co ON c.id = co.client_id
WHERE co.date_commande >= '2024-01-01';
```

### Lisibilit√© du code
```sql
-- Formatage recommand√©
SELECT 
    p.nom AS produit,
    p.prix,
    c.nom AS categorie,
    COUNT(v.id) AS nb_ventes
FROM produits p
INNER JOIN categories c ON p.categorie_id = c.id
LEFT JOIN ventes v ON p.id = v.produit_id
WHERE p.actif = 1
  AND p.prix > 0
GROUP BY p.id, p.nom, p.prix, c.nom
HAVING COUNT(v.id) > 10
ORDER BY nb_ventes DESC, p.prix ASC
LIMIT 20;
```

### Gestion des erreurs courantes
```sql
-- Attention aux divisions par z√©ro
SELECT 
    produit,
    CASE 
        WHEN ventes_totales = 0 THEN 0
        ELSE benefice / ventes_totales 
    END AS marge
FROM statistiques;

-- Gestion des NULL dans les calculs
SELECT 
    nom,
    COALESCE(prix_promo, prix_normal) AS prix_final
FROM produits;
```

## üéØ Cas d'usage fr√©quents

### Analyse des ventes
```sql
-- √âvolution mensuelle du chiffre d'affaires
SELECT 
    DATE_FORMAT(date_commande, '%Y-%m') AS mois,
    COUNT(*) AS nb_commandes,
    SUM(total) AS ca,
    AVG(total) AS panier_moyen
FROM commandes
WHERE date_commande >= DATE_SUB(NOW(), INTERVAL 12 MONTH)
GROUP BY DATE_FORMAT(date_commande, '%Y-%m')
ORDER BY mois;
```

### Recherche de donn√©es manquantes
```sql
-- Clients sans commandes
SELECT c.nom, c.email, c.date_inscription
FROM clients c
LEFT JOIN commandes co ON c.id = co.client_id
WHERE co.id IS NULL
  AND c.date_inscription < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

### Classements et percentiles
```sql
-- Top 20% des clients par chiffre d'affaires
SELECT 
    c.nom,
    SUM(co.total) AS ca_total,
    RANK() OVER (ORDER BY SUM(co.total) DESC) AS rang
FROM clients c
INNER JOIN commandes co ON c.id = co.client_id
GROUP BY c.id, c.nom
ORDER BY ca_total DESC
LIMIT (SELECT COUNT(*) * 0.2 FROM clients);
```
